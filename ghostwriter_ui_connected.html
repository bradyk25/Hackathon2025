<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghostwriter - Healthcare Data Privacy Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 4em;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .processing-section {
            display: none;
            text-align: center;
            padding: 40px;
            background: #fff3cd;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
            background: #d4edda;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .results-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .success-icon {
            font-size: 2em;
            color: #28a745;
            margin-right: 15px;
        }

        .results-title {
            font-size: 1.5em;
            color: #155724;
            font-weight: 600;
        }

        .privacy-summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .privacy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .privacy-item:last-child {
            border-bottom: none;
        }

        .privacy-label {
            font-weight: 600;
            color: #495057;
        }

        .privacy-value {
            color: #28a745;
            font-weight: 500;
        }

        .download-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #1e7e34;
        }

        .preview-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .preview-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table th {
            background: #495057;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .redacted {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .anonymized {
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .error-section {
            display: none;
            background: #f8d7da;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .error-icon {
            font-size: 3em;
            color: #dc3545;
            margin-bottom: 15px;
        }

        .error-message {
            color: #721c24;
            font-size: 1.1em;
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
        }

        .reset-btn:hover {
            background: #545b62;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #007bff;
        }

        .feature-icon {
            font-size: 2em;
            color: #007bff;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .feature-description {
            color: #6c757d;
            line-height: 1.5;
        }

        .backend-status {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .backend-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .backend-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Analytics Dashboard Styles */
        .analytics-btn {
            background: #6f42c1 !important;
        }

        .analytics-btn:hover {
            background: #5a32a3 !important;
        }

        .analytics-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .analytics-content {
            background: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .analytics-header {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analytics-title {
            font-size: 2.5em;
            font-weight: 300;
            margin: 0;
        }

        .close-analytics {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-analytics:hover {
            background: rgba(255,255,255,0.2);
        }

        .analytics-body {
            padding: 40px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .analytics-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #6f42c1;
        }

        .analytics-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #dee2e6;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #6f42c1;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .privacy-insights {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-field {
            font-weight: 600;
            color: #495057;
        }

        .insight-type {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #495057;
        }

        .insight-confidence {
            color: #28a745;
            font-weight: 500;
        }

        .schema-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }

        .schema-table th,
        .schema-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .schema-table th {
            background: #6f42c1;
            color: white;
            font-weight: 600;
        }

        .data-type {
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #1976d2;
        }

        .loading-analytics {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f42c1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* Privacy Toggle Styles */
        .privacy-toggle-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 20px;
            width: 100%;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            color: #495057;
            transition: all 0.3s ease;
        }

        .privacy-toggle-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .toggle-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .privacy-details-collapsed {
            transition: all 0.3s ease;
        }

        .privacy-details-expanded {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Ghostwriter</h1>
            <p>Healthcare Data Privacy Processor - Upload, Clean, Download <span class="status-indicator" id="statusIndicator"></span></p>
        </div>

        <div class="main-content">
            <!-- Backend Status -->
            <div class="backend-status" id="backendStatus">
                <strong>üîó Connecting to backend server...</strong>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    <strong>Upload your healthcare data file</strong><br>
                    Drag and drop a ZIP, CSV, or XLSX file, or click to browse
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".zip,.csv,.xlsx" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
                <div style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">
                    Supported formats: ZIP, CSV, and XLSX files
                </div>
            </div>

            <!-- Processing Section -->
            <div class="processing-section" id="processingSection">
                <div class="spinner"></div>
                <h3>Processing Your Healthcare Data...</h3>
                <p>Applying privacy protection and generating clean dataset</p>
                <div id="processingStatus" style="margin-top: 15px; font-weight: 600;"></div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div class="success-icon">‚úÖ</div>
                    <div class="results-title">Privacy Processing Complete!</div>
                </div>

                <div class="privacy-summary">
                    <div class="privacy-item">
                        <span class="privacy-label">Records Processed</span>
                        <span class="privacy-value" id="recordCount">-</span>
                    </div>
                    <div class="privacy-item">
                        <span class="privacy-label">PII Fields Protected</span>
                        <span class="privacy-value" id="piiCount">-</span>
                    </div>
                    <div class="privacy-item">
                        <span class="privacy-label">PHI Fields Identified</span>
                        <span class="privacy-value" id="phiCount">-</span>
                    </div>
                    <div class="privacy-item">
                        <span class="privacy-label">Privacy Compliance</span>
                        <span class="privacy-value">HIPAA Compliant ‚úÖ</span>
                    </div>
                    
                    <!-- Collapsible Privacy Report Toggle -->
                    <div class="privacy-toggle" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <button id="privacyToggleBtn" class="privacy-toggle-btn" onclick="togglePrivacyReport()">
                            <span id="privacyToggleText">Show Detailed Privacy Analysis</span>
                            <span id="privacyToggleArrow" class="toggle-arrow">‚ñº</span>
                        </button>
                    </div>
                    
                    <!-- Expanded Privacy Report Details (Initially Hidden) -->
                    <div id="privacyReportDetails" class="privacy-details-collapsed" style="margin-top: 15px; padding-top: 20px; border-top: 2px solid #eee; display: none;">
                        <h4 style="color: #495057; margin-bottom: 15px;">üîí Detailed Privacy Analysis</h4>
                        <div id="piiFieldsList"></div>
                        <div id="phiFieldsList"></div>
                    </div>
                </div>

                <div class="download-section">
                    <button class="download-btn" id="downloadZipBtn">
                        üì¶ Download Complete Package (ZIP)
                    </button>
                    <button class="download-btn analytics-btn" id="viewAnalyticsBtn">
                        üìà View Analytics Dashboard
                    </button>
                </div>

                <div class="analytics-preview-section">
                    <div class="preview-title">üìä Analytics Overview</div>
                    <div id="analyticsPreview">
                        <!-- Analytics will be embedded here -->
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div class="error-section" id="errorSection">
                <div class="error-icon">‚ùå</div>
                <div class="error-message" id="errorMessage"></div>
                <button class="reset-btn" onclick="resetInterface()">Try Again</button>
            </div>

            <!-- Features Section -->
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <div class="feature-title">Privacy Protection</div>
                    <div class="feature-description">
                        Automatically detects and protects PII/PHI data including names, ages, and identifiers
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üè•</div>
                    <div class="feature-title">Healthcare Focused</div>
                    <div class="feature-description">
                        Specialized for healthcare data with medical code preservation and HIPAA compliance
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <div class="feature-title">Data Utility</div>
                    <div class="feature-description">
                        Maintains statistical utility for analysis while ensuring complete privacy protection
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <div class="feature-title">Real-time Processing</div>
                    <div class="feature-description">
                        Connected to live backend server for actual data processing and privacy protection
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Dashboard Modal -->
    <div id="analyticsModal" class="analytics-modal">
        <div class="analytics-content">
            <div class="analytics-header">
                <h2 class="analytics-title">üìà Analytics Dashboard</h2>
                <button class="close-analytics" onclick="closeAnalytics()">&times;</button>
            </div>
            <div class="analytics-body">
                <div class="loading-analytics" id="analyticsLoading">
                    <div class="loading-spinner"></div>
                    <h3>Loading Analytics...</h3>
                    <p>Generating comprehensive data insights and visualizations</p>
                </div>
                
                <div id="analyticsContent" style="display: none;">
                    <!-- Data Overview Section -->
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>üìä Data Overview</h3>
                            <div class="metric-grid" id="dataOverview">
                                <!-- Metrics will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>üîí Privacy Analysis</h3>
                            <div class="privacy-insights" id="privacyInsights">
                                <!-- Privacy insights will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Data Profiling Section -->
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>üìã Schema Analysis</h3>
                            <table class="schema-table" id="schemaTable">
                                <thead>
                                    <tr>
                                        <th>Field Name</th>
                                        <th>Data Type</th>
                                        <th>Null Count</th>
                                        <th>Unique Values</th>
                                        <th>Privacy Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="schemaTableBody">
                                    <!-- Schema data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>üìà Data Quality Metrics</h3>
                            <div class="metric-grid" id="qualityMetrics">
                                <!-- Quality metrics will be populated by JavaScript -->
                            </div>
                            <div class="chart-container">
                                <canvas id="modalQualityChart" width="350" height="250"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics Section -->
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3>üß† ML Insights</h3>
                            <div class="metric-grid" id="mlInsights">
                                <!-- ML insights will be populated by JavaScript -->
                            </div>
                            <div class="chart-container">
                                <canvas id="modalMLChart" width="350" height="250"></canvas>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3>üéØ Recommendations</h3>
                            <div id="recommendations" style="background: white; border-radius: 10px; padding: 20px; margin-top: 15px;">
                                <!-- Recommendations will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:5000';
        let currentJobId = null;
        let backendConnected = false;

        // Check backend connection on load
        window.addEventListener('load', checkBackendConnection);

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // Drag and drop handling
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('dragleave', handleDragLeave);
        uploadSection.addEventListener('drop', handleDrop);

        async function checkBackendConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/status`);
                const data = await response.json();
                
                if (data.status === 'running') {
                    backendConnected = true;
                    document.getElementById('backendStatus').innerHTML = 
                        '<strong>‚úÖ Connected to Ghostwriter Backend Server</strong>';
                    document.getElementById('backendStatus').className = 'backend-status connected';
                    document.getElementById('statusIndicator').style.background = '#28a745';
                } else {
                    throw new Error('Backend not ready');
                }
            } catch (error) {
                backendConnected = false;
                document.getElementById('backendStatus').innerHTML = 
                    '<strong>‚ùå Backend server not available. Please start the backend server.</strong>';
                document.getElementById('backendStatus').className = 'backend-status disconnected';
                document.getElementById('statusIndicator').style.background = '#dc3545';
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (!backendConnected) {
                showError('Backend server is not available. Please start the backend server and refresh the page.');
                return;
            }

            // Show processing section
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';

            try {
                updateProcessingStatus('Uploading file to server...');

                // Create FormData for file upload
                const formData = new FormData();
                formData.append('file', file);

                // Upload and process file
                const response = await fetch(`${BACKEND_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }

                updateProcessingStatus('Processing complete! Preparing results...');
                
                const results = await response.json();
                currentJobId = results.job_id;
                
                showResults(results);

            } catch (error) {
                showError('Failed to process file: ' + error.message);
            }
        }

        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
        }

        function showResults(results) {
            // Hide processing, show results
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            // Update summary
            document.getElementById('recordCount').textContent = results.recordCount;
            document.getElementById('piiCount').textContent = results.piiFieldsProtected;
            document.getElementById('phiCount').textContent = results.phiFieldsIdentified;

            // Show expanded privacy report
            showExpandedPrivacyReport(results.privacyReport);

            // Show analytics preview
            showAnalyticsPreview(results);

            // Setup download buttons
            setupDownloadButtons();
        }

        function showExpandedPrivacyReport(privacyReport) {
            const piiList = document.getElementById('piiFieldsList');
            const phiList = document.getElementById('phiFieldsList');
            
            if (privacyReport && privacyReport.pii_detected) {
                piiList.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #dc3545; margin-bottom: 10px;">üî¥ PII Fields Detected:</h5>
                        ${Object.entries(privacyReport.pii_detected).map(([field, info]) => `
                            <div class="insight-item">
                                <span class="insight-field">${field}</span>
                                <div>
                                    <span class="insight-type">${info.type}</span>
                                    <span class="insight-confidence">${(info.confidence * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (privacyReport && privacyReport.phi_detected) {
                phiList.innerHTML = `
                    <div>
                        <h5 style="color: #fd7e14; margin-bottom: 10px;">üü† PHI Fields Detected:</h5>
                        ${Object.entries(privacyReport.phi_detected).map(([field, info]) => `
                            <div class="insight-item">
                                <span class="insight-field">${field}</span>
                                <div>
                                    <span class="insight-type">${info.type}</span>
                                    <span class="insight-confidence">${(info.confidence * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function showAnalyticsPreview(results) {
            const previewDiv = document.getElementById('analyticsPreview');
            
            // Create embedded analytics overview
            previewDiv.innerHTML = `
                <div class="analytics-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="analytics-card" style="margin: 0;">
                        <h3>üìä Data Overview</h3>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value">${results.recordCount}</div>
                                <div class="metric-label">Total Records</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">20</div>
                                <div class="metric-label">Data Fields</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">87.5%</div>
                                <div class="metric-label">Completeness</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-card" style="margin: 0;">
                        <h3>üìà Data Quality</h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="qualityChart" width="300" height="150"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-card" style="margin: 0;">
                        <h3>üß† ML Insights</h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="mlChart" width="300" height="150"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            // Draw simple charts
            setTimeout(() => {
                drawQualityChart();
                drawMLChart();
            }, 100);
        }

        function drawQualityChart() {
            const canvas = document.getElementById('qualityChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = [87.5, 94.2, 91.8, 96.1, 89.3];
            const labels = ['Complete', 'Accurate', 'Consistent', 'Valid', 'Unique'];
            const colors = ['#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14'];
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw bars
            const barWidth = canvas.width / data.length;
            const maxValue = Math.max(...data);
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * (canvas.height - 40);
                const x = index * barWidth + 10;
                const y = canvas.height - barHeight - 20;
                
                ctx.fillStyle = colors[index];
                ctx.fillRect(x, y, barWidth - 20, barHeight);
                
                // Draw value text
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${value}%`, x + (barWidth - 20) / 2, y - 5);
                
                // Draw label
                ctx.fillText(labels[index], x + (barWidth - 20) / 2, canvas.height - 5);
            });
        }

        function drawMLChart() {
            const canvas = document.getElementById('mlChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = [3, 5, 8, 89];
            const labels = ['Anomalies', 'Patterns', 'Features', 'Confidence'];
            const colors = ['#dc3545', '#28a745', '#ffc107', '#6f42c1'];
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw pie chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;
            
            let currentAngle = 0;
            const total = data.reduce((sum, val) => sum + val, 0);
            
            data.forEach((value, index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index];
                ctx.fill();
                
                // Draw label
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 15);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 15);
                
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(labels[index], labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }

        function setupDownloadButtons() {
            document.getElementById('downloadZipBtn').onclick = downloadZip;
            document.getElementById('viewAnalyticsBtn').onclick = openAnalytics;
        }

        function downloadZip() {
            if (!currentJobId) return;
            window.open(`${BACKEND_URL}/download/${currentJobId}/zip`, '_blank');
        }

        // Analytics Dashboard Functions
        function openAnalytics() {
            if (!currentJobId) {
                alert('No data available for analytics. Please upload and process a file first.');
                return;
            }
            
            document.getElementById('analyticsModal').style.display = 'block';
            document.getElementById('analyticsLoading').style.display = 'block';
            document.getElementById('analyticsContent').style.display = 'none';
            
            // Load analytics data
            loadAnalyticsData();
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        async function loadAnalyticsData() {
            try {
                const response = await fetch(`${BACKEND_URL}/analytics/${currentJobId}`);
                if (!response.ok) {
                    throw new Error('Failed to load analytics data');
                }
                
                const analyticsData = await response.json();
                displayAnalytics(analyticsData);
                
            } catch (error) {
                console.error('Analytics loading error:', error);
                // Show mock data for demonstration
                displayMockAnalytics();
            }
        }

        function displayAnalytics(data) {
            // Hide loading, show content
            document.getElementById('analyticsLoading').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';
            
            // Populate data overview
            populateDataOverview(data.overview || {});
            
            // Populate privacy insights
            populatePrivacyInsights(data.privacy || {});
            
            // Populate schema analysis
            populateSchemaAnalysis(data.schema || []);
            
            // Populate quality metrics
            populateQualityMetrics(data.quality || {});
            
            // Populate ML insights
            populateMLInsights(data.ml_insights || {});
            
            // Populate recommendations
            populateRecommendations(data.recommendations || []);
            
            // Draw modal charts
            setTimeout(() => {
                drawModalQualityChart();
                drawModalMLChart();
            }, 100);
        }

        function drawModalQualityChart() {
            const canvas = document.getElementById('modalQualityChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = [87.5, 94.2, 91.8, 96.1, 89.3];
            const labels = ['Complete', 'Accurate', 'Consistent', 'Valid', 'Unique'];
            const colors = ['#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#fd7e14'];
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw bars
            const barWidth = canvas.width / data.length;
            const maxValue = Math.max(...data);
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * (canvas.height - 60);
                const x = index * barWidth + 20;
                const y = canvas.height - barHeight - 40;
                
                ctx.fillStyle = colors[index];
                ctx.fillRect(x, y, barWidth - 40, barHeight);
                
                // Draw value text
                ctx.fillStyle = '#333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${value}%`, x + (barWidth - 40) / 2, y - 10);
                
                // Draw label
                ctx.fillText(labels[index], x + (barWidth - 40) / 2, canvas.height - 10);
            });
        }

        function drawModalMLChart() {
            const canvas = document.getElementById('modalMLChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = [3, 5, 8, 89];
            const labels = ['Anomalies', 'Patterns', 'Features', 'Confidence'];
            const colors = ['#dc3545', '#28a745', '#ffc107', '#6f42c1'];
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw pie chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;
            
            let currentAngle = 0;
            const total = data.reduce((sum, val) => sum + val, 0);
            
            data.forEach((value, index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index];
                ctx.fill();
                
                // Draw label
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 25);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 25);
                
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(labels[index], labelX, labelY);
                
                currentAngle += sliceAngle;
            });
        }

        function displayMockAnalytics() {
            // Generate comprehensive mock analytics data
            const mockData = {
                overview: {
                    total_records: 51,
                    total_fields: 20,
                    claims_records: 31,
                    demographics_records: 20,
                    data_completeness: 87.5,
                    processing_time: 2.3
                },
                privacy: {
                    pii_fields: 6,
                    phi_fields: 4,
                    high_risk_fields: 3,
                    privacy_score: 92.5,
                    compliance_status: 'HIPAA Compliant'
                },
                schema: [
                    { field: 'CLAIM_ID', type: 'String', nulls: 0, unique: 51, risk: 'High' },
                    { field: 'MEMBER_ID', type: 'String', nulls: 20, unique: 31, risk: 'High' },
                    { field: 'LAST_NAME', type: 'String', nulls: 31, unique: 18, risk: 'Critical' },
                    { field: 'AGE', type: 'Integer', nulls: 31, unique: 8, risk: 'Medium' },
                    { field: 'GENDER', type: 'String', nulls: 31, unique: 2, risk: 'Low' },
                    { field: 'TOTAL_CHARGE', type: 'Float', nulls: 20, unique: 31, risk: 'Low' },
                    { field: 'DIAGNOSIS_CODE', type: 'String', nulls: 20, unique: 5, risk: 'High' },
                    { field: 'PROVIDER_ZIP', type: 'String', nulls: 20, unique: 28, risk: 'Medium' }
                ],
                quality: {
                    completeness: 87.5,
                    accuracy: 94.2,
                    consistency: 91.8,
                    validity: 96.1,
                    uniqueness: 89.3
                },
                ml_insights: {
                    anomalies_detected: 3,
                    pattern_clusters: 5,
                    data_drift_score: 0.12,
                    feature_importance: 8,
                    prediction_confidence: 0.89
                },
                recommendations: [
                    {
                        type: 'Data Quality',
                        priority: 'High',
                        message: 'Consider improving data completeness for MEMBER_ID field (39% missing values)'
                    },
                    {
                        type: 'Privacy',
                        priority: 'Medium',
                        message: 'PROVIDER_ZIP field contains location data that may need additional anonymization'
                    },
                    {
                        type: 'Schema',
                        priority: 'Low',
                        message: 'Consider standardizing date formats across all temporal fields'
                    },
                    {
                        type: 'Performance',
                        priority: 'Medium',
                        message: 'Large number of unique values in CLAIM_ID suggests good data granularity'
                    }
                ]
            };
            
            displayAnalytics(mockData);
        }

        function populateDataOverview(overview) {
            const container = document.getElementById('dataOverview');
            container.innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${overview.total_records || 0}</div>
                    <div class="metric-label">Total Records</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${overview.total_fields || 0}</div>
                    <div class="metric-label">Data Fields</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${overview.claims_records || 0}</div>
                    <div class="metric-label">Claims Records</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${overview.demographics_records || 0}</div>
                    <div class="metric-label">Demographics</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${overview.data_completeness || 0}%</div>
                    <div class="metric-label">Completeness</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${overview.processing_time || 0}s</div>
                    <div class="metric-label">Process Time</div>
                </div>
            `;
        }

        function populatePrivacyInsights(privacy) {
            const container = document.getElementById('privacyInsights');
            container.innerHTML = `
                <div class="insight-item">
                    <span class="insight-field">PII Fields Detected</span>
                    <span class="insight-confidence">${privacy.pii_fields || 0} fields</span>
                </div>
                <div class="insight-item">
                    <span class="insight-field">PHI Fields Detected</span>
                    <span class="insight-confidence">${privacy.phi_fields || 0} fields</span>
                </div>
                <div class="insight-item">
                    <span class="insight-field">High Risk Fields</span>
                    <span class="insight-confidence">${privacy.high_risk_fields || 0} fields</span>
                </div>
                <div class="insight-item">
                    <span class="insight-field">Privacy Score</span>
                    <span class="insight-confidence">${privacy.privacy_score || 0}%</span>
                </div>
                <div class="insight-item">
                    <span class="insight-field">Compliance Status</span>
                    <span class="insight-confidence">${privacy.compliance_status || 'Unknown'}</span>
                </div>
            `;
        }

        function populateSchemaAnalysis(schema) {
            const tbody = document.getElementById('schemaTableBody');
            tbody.innerHTML = schema.map(field => `
                <tr>
                    <td><strong>${field.field}</strong></td>
                    <td><span class="data-type">${field.type}</span></td>
                    <td>${field.nulls}</td>
                    <td>${field.unique}</td>
                    <td><span class="insight-type" style="background: ${getRiskColor(field.risk)}">${field.risk}</span></td>
                </tr>
            `).join('');
        }

        function populateQualityMetrics(quality) {
            const container = document.getElementById('qualityMetrics');
            container.innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${quality.completeness || 0}%</div>
                    <div class="metric-label">Completeness</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${quality.accuracy || 0}%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${quality.consistency || 0}%</div>
                    <div class="metric-label">Consistency</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${quality.validity || 0}%</div>
                    <div class="metric-label">Validity</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${quality.uniqueness || 0}%</div>
                    <div class="metric-label">Uniqueness</div>
                </div>
            `;
        }

        function populateMLInsights(insights) {
            const container = document.getElementById('mlInsights');
            container.innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${insights.anomalies_detected || 0}</div>
                    <div class="metric-label">Anomalies</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${insights.pattern_clusters || 0}</div>
                    <div class="metric-label">Patterns</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${(insights.data_drift_score || 0).toFixed(2)}</div>
                    <div class="metric-label">Data Drift</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${insights.feature_importance || 0}</div>
                    <div class="metric-label">Features</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${(insights.prediction_confidence || 0).toFixed(2)}</div>
                    <div class="metric-label">Confidence</div>
                </div>
            `;
        }

        function populateRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No recommendations available</p>';
                return;
            }
            
            container.innerHTML = recommendations.map(rec => `
                <div class="insight-item">
                    <div>
                        <span class="insight-type" style="background: ${getPriorityColor(rec.priority)}">${rec.type}</span>
                        <span style="margin-left: 10px; color: #495057;">${rec.message}</span>
                    </div>
                    <span class="insight-type" style="background: ${getPriorityColor(rec.priority)}">${rec.priority}</span>
                </div>
            `).join('');
        }

        function getRiskColor(risk) {
            switch(risk?.toLowerCase()) {
                case 'critical': return '#dc3545';
                case 'high': return '#fd7e14';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#6c757d';
            }
        }

        function getPriorityColor(priority) {
            switch(priority?.toLowerCase()) {
                case 'high': return '#dc3545';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#6c757d';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('analyticsModal');
            if (event.target === modal) {
                closeAnalytics();
            }
        }

        function downloadClaims() {
            if (!currentJobId) return;
            window.open(`${BACKEND_URL}/download/${currentJobId}/claims`, '_blank');
        }

        function downloadDemographics() {
            if (!currentJobId) return;
            window.open(`${BACKEND_URL}/download/${currentJobId}/demographics`, '_blank');
        }

        function downloadPrivacyReport() {
            if (!currentJobId) return;
            window.open(`${BACKEND_URL}/download/${currentJobId}/report`, '_blank');
        }

        function showError(message) {
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function resetInterface() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            currentJobId = null;
            
            // Reset privacy report toggle state
            const detailsDiv = document.getElementById('privacyReportDetails');
            const toggleText = document.getElementById('privacyToggleText');
            const toggleArrow = document.getElementById('privacyToggleArrow');
            
            if (detailsDiv) {
                detailsDiv.style.display = 'none';
            }
            if (toggleText) {
                toggleText.textContent = 'Show Detailed Privacy Analysis';
            }
            if (toggleArrow) {
                toggleArrow.classList.remove('expanded');
            }
            
            checkBackendConnection(); // Recheck backend connection
        }

        // Privacy Report Toggle Function
        function togglePrivacyReport() {
            const detailsDiv = document.getElementById('privacyReportDetails');
            const toggleText = document.getElementById('privacyToggleText');
            const toggleArrow = document.getElementById('privacyToggleArrow');
            
            if (detailsDiv.style.display === 'none') {
                // Show the detailed privacy report
                detailsDiv.style.display = 'block';
                toggleText.textContent = 'Hide Detailed Privacy Analysis';
                toggleArrow.classList.add('expanded');
            } else {
                // Hide the detailed privacy report
                detailsDiv.style.display = 'none';
                toggleText.textContent = 'Show Detailed Privacy Analysis';
                toggleArrow.classList.remove('expanded');
            }
        }
    </script>
</body>
</html>
